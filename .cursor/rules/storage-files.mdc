---
description: RÃ¨gles de gestion des fichiers, stockage Cloudflare R2, gÃ©nÃ©ration de fichiers floutÃ©s et endpoints API associÃ©s
globs: ["src/lib/files/**/*", "src/app/api/upload/**/*", "src/app/api/products/**/*"]
alwaysApply: true
---

# ğŸ“ RÃ¨gles Stockage et Fichiers

## Cloudflare R2

1. **Upload des fichiers** vers R2
2. **Structure** : `users/{userId}/content/` pour les fichiers originaux
3. **Structure** : `users/{userId}/content/blurred/` pour les fichiers floutÃ©s
4. **Variables d'environnement** requises : R2_ACCOUNT_ID, R2_ACCESS_KEY_ID, R2_SECRET_ACCESS_KEY, R2_BUCKET_NAME

## GÃ©nÃ©ration de fichiers floutÃ©s

1. **Sharp** pour le traitement d'images
2. **Niveau de flou par dÃ©faut** : 20 (Ã©chelle 0-100)
3. **QualitÃ©** : 80%, Format : JPEG
4. **GÃ©nÃ©ration en arriÃ¨re-plan** non-bloquante

## SÃ©curitÃ© des fichiers

1. **Validation des types** de fichiers
2. **Limitation de taille**
3. **Scan antivirus** (optionnel)

## Structure des fichiers

```
users/
â”œâ”€â”€ {userId}/
â”‚   â”œâ”€â”€ content/           # Fichiers originaux
â”‚   â”‚   â”œâ”€â”€ image1.jpg
â”‚   â”‚   â””â”€â”€ image2.png
â”‚   â””â”€â”€ content/blurred/   # Fichiers floutÃ©s
â”‚       â”œâ”€â”€ image1_blurred.jpg
â”‚       â””â”€â”€ image2_blurred.png
```

## API Endpoints

### GÃ©nÃ©rer les fichiers floutÃ©s
```http
POST /api/products/{productId}/generate-blurred
```

### Upload de fichiers
```http
POST /api/upload/presigned-url
```

### Upload de fichiers
```http
POST /api/upload/presigned-url
```

POST /api/upload/presigned-url
```
