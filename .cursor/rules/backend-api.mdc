---
description: R√®gles et conventions pour le d√©veloppement backend, API Routes, Server Actions, base de donn√©es Prisma et authentification NextAuth
globs: ["src/lib/actions/**/*", "src/lib/validations/**/*", "prisma/**/*", "src/app/api/**/*"]
alwaysApply: true
---

# üîß R√®gles Backend et API

## Server Actions

1. **Toutes les requ√™tes serveur** (insertions, updates, deletions) doivent passer par les Server Actions Next.js.
2. **Valider syst√©matiquement** les payloads backend avec **Zod**.
3. **G√©rer les erreurs proprement** avec **try/catch** et messages explicites.
4. **Aucun appel √† la base de donn√©es c√¥t√© client** - toutes les op√©rations DB doivent √™tre dans les Server Actions.
5. **Privil√©gier les Server Actions** pour les mutations plut√¥t que les API Routes.

## Base de donn√©es

1. Utiliser **Prisma** pour toutes les op√©rations sur la base de donn√©es.
2. Le **sch√©ma** doit √™tre centralis√© dans `prisma/schema.prisma`.
3. Les **migrations** doivent √™tre automatis√©es via Prisma Migrate.

## Authentification

1. La gestion des sessions doit √™tre assur√©e via **NextAuth**.
2. Le projet doit prendre en charge le **multi-provider** (Google, Facebook, Apple, email).
3. Les mots de passe doivent √™tre **hach√©s avec bcrypt**.

## API Routes

1. **Valider les webhooks Stripe** correctement avec la signature.
2. Impl√©menter la **protection CSRF** sur les routes sensibles.
3. Appliquer des **headers de s√©curit√©** stricts sur toutes les r√©ponses API.

## Variables d'environnement requises

```env
# Base de donn√©es
DATABASE_URL="postgresql://..."

# NextAuth
NEXTAUTH_SECRET="..."
NEXTAUTH_URL="http://localhost:3000"

# Google OAuth
GOOGLE_CLIENT_ID="..."
GOOGLE_CLIENT_SECRET="..."

# Facebook OAuth
FACEBOOK_CLIENT_ID="..."
FACEBOOK_CLIENT_SECRET="..."

# Apple OAuth
APPLE_ID="..."
APPLE_TEAM_ID="..."
APPLE_PRIVATE_KEY="..."

# Stripe
STRIPE_SECRET_KEY="..."
STRIPE_WEBHOOK_SECRET="..."
STRIPE_PUBLISHABLE_KEY="..."

# Cloudflare R2
R2_ACCOUNT_ID="..."
R2_ACCESS_KEY_ID="..."
R2_SECRET_ACCESS_KEY="..."
R2_BUCKET_NAME="..."
R2_PUBLIC_URL="..."

# Logging
LOG_LEVEL="info"
